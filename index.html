<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ORBIT — Спутниковый Трекер</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Rajdhani:wght@300;400;600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #020408;
    --panel: rgba(5, 15, 30, 0.92);
    --border: rgba(0, 200, 255, 0.2);
    --accent: #00c8ff;
    --accent2: #ff4060;
    --accent3: #00ff9f;
    --text: #c8e0f0;
    --dim: rgba(200, 224, 240, 0.45);
    --debris: #ff6030;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
    cursor: crosshair;
  }

  #canvas { display: block; }

  /* HUD */
  #hud-top {
    position: fixed;
    top: 0; left: 0; right: 0;
    padding: 14px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(to bottom, rgba(2,4,8,0.9), transparent);
    pointer-events: none;
    z-index: 10;
  }

  .logo {
    font-family: 'Space Mono', monospace;
    font-size: 22px;
    letter-spacing: 6px;
    color: var(--accent);
    text-shadow: 0 0 20px var(--accent);
  }

  .logo span { color: var(--accent2); }

  .hud-stats {
    display: flex;
    gap: 32px;
    font-size: 13px;
    letter-spacing: 2px;
  }

  .stat-item { text-align: center; }
  .stat-val { font-family: 'Space Mono', monospace; color: var(--accent3); font-size: 18px; }
  .stat-lbl { color: var(--dim); font-size: 10px; }

  /* Legend */
  #legend {
    position: fixed;
    bottom: 24px; left: 24px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 14px 18px;
    z-index: 10;
    pointer-events: none;
    backdrop-filter: blur(10px);
  }

  .legend-title {
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--dim);
    margin-bottom: 10px;
    text-transform: uppercase;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 6px 0;
    font-size: 13px;
  }

  .dot {
    width: 8px; height: 8px; border-radius: 50%;
    flex-shrink: 0;
    box-shadow: 0 0 6px currentColor;
  }

  /* Info Panel */
  #info-panel {
    position: fixed;
    top: 80px; right: 24px;
    width: 340px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 6px;
    backdrop-filter: blur(16px);
    z-index: 20;
    display: none;
    overflow: hidden;
    box-shadow: 0 0 40px rgba(0,200,255,0.1), 0 0 80px rgba(0,0,0,0.8);
  }

  #info-panel.visible { display: block; animation: slideIn 0.25s ease; }

  @keyframes slideIn {
    from { opacity: 0; transform: translateX(20px); }
    to   { opacity: 1; transform: translateX(0); }
  }

  .panel-header {
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(0,200,255,0.05);
  }

  .panel-name {
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 2px;
    color: var(--accent);
    text-transform: uppercase;
    text-shadow: 0 0 10px var(--accent);
    max-width: 240px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .panel-type {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 2px;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .type-active { background: rgba(0,255,159,0.15); color: var(--accent3); border: 1px solid rgba(0,255,159,0.3); }
  .type-debris { background: rgba(255,96,48,0.15); color: var(--debris); border: 1px solid rgba(255,96,48,0.3); }

  .tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
  }

  .tab {
    flex: 1;
    padding: 9px 4px;
    text-align: center;
    font-size: 11px;
    letter-spacing: 0.5px;
    cursor: pointer;
    color: var(--dim);
    transition: all 0.2s;
    text-transform: uppercase;
    border: none;
    background: transparent;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    white-space: nowrap;
  }

  .tab:hover { color: var(--text); background: rgba(0,200,255,0.05); }
  .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }

  .tab-content { display: none; padding: 16px 18px; }
  .tab-content.active { display: block; }

  .info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 7px 0;
    border-bottom: 1px solid rgba(0,200,255,0.07);
    font-size: 13px;
  }

  .info-row:last-child { border-bottom: none; }

  .info-key { color: var(--dim); letter-spacing: 1px; font-size: 12px; }
  .info-val { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--text); }
  .info-val.highlight { color: var(--accent3); }
  .info-val.warn { color: var(--accent2); }

  .orbit-visual {
    margin: 12px 0;
    position: relative;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .orbit-svg { width: 120px; height: 120px; }

  .orbit-stats { margin-top: 8px; }

  /* Condition tab */
  .condition-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }

  .condition-indicator {
    width: 12px; height: 12px; border-radius: 50%;
    flex-shrink: 0;
    animation: blink 2s ease-in-out infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; box-shadow: 0 0 6px currentColor; }
    50% { opacity: 0.4; box-shadow: none; }
  }

  .condition-label {
    font-size: 15px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .condition-desc {
    font-size: 13px;
    line-height: 1.7;
    color: var(--text);
    margin-bottom: 12px;
    opacity: 0.85;
  }

  .condition-metrics {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 10px;
  }

  .metric-box {
    background: rgba(0,200,255,0.04);
    border: 1px solid rgba(0,200,255,0.1);
    border-radius: 4px;
    padding: 8px 10px;
    text-align: center;
  }

  .metric-val {
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    color: var(--accent3);
    display: block;
  }

  .metric-val.warn { color: var(--accent2); }
  .metric-val.neutral { color: var(--accent); }

  .metric-lbl {
    font-size: 10px;
    color: var(--dim);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-top: 2px;
    display: block;
  }

  .condition-events {
    margin-top: 12px;
  }

  .event-item {
    display: flex;
    gap: 10px;
    padding: 6px 0;
    border-bottom: 1px solid rgba(0,200,255,0.06);
    font-size: 12px;
    align-items: flex-start;
  }

  .event-item:last-child { border-bottom: none; }

  .event-date {
    font-family: 'Space Mono', monospace;
    color: var(--dim);
    font-size: 10px;
    min-width: 70px;
    padding-top: 1px;
    flex-shrink: 0;
  }

  .event-text { color: var(--text); line-height: 1.5; }

  /* Collision risk block */
  .collision-block {
    margin-top: 14px;
    border: 1px solid rgba(255,96,48,0.3);
    border-radius: 4px;
    overflow: hidden;
  }

  .collision-header {
    background: rgba(255,64,48,0.1);
    padding: 8px 12px;
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--debris);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .collision-header::before {
    content: '⚠';
    font-size: 13px;
  }

  .risk-bar-wrap {
    padding: 10px 12px;
    background: rgba(255,96,48,0.03);
  }

  .risk-label-row {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    margin-bottom: 6px;
  }

  .risk-label { color: var(--dim); letter-spacing: 1px; }
  .risk-value { font-family: 'Space Mono', monospace; font-weight: 700; }

  .risk-bar-bg {
    height: 5px;
    background: rgba(255,255,255,0.07);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 10px;
  }

  .risk-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.5s ease;
  }

  .collision-details {
    padding: 0 12px 10px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
  }

  .cd-item {
    font-size: 11px;
  }
  .cd-key { color: var(--dim); font-size: 10px; letter-spacing: 1px; display: block; margin-bottom: 2px; }
  .cd-val { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--text); }

  .close-btn {
    background: none;
    border: none;
    color: var(--dim);
    cursor: pointer;
    font-size: 18px;
    padding: 0 4px;
    line-height: 1;
    transition: color 0.2s;
  }
  .close-btn:hover { color: var(--accent2); }

  /* Controls hint */
  #controls-hint {
    position: fixed;
    bottom: 24px; right: 24px;
    text-align: right;
    font-size: 11px;
    color: var(--dim);
    letter-spacing: 1px;
    pointer-events: none;
    line-height: 2;
  }

  /* Scanline */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      to bottom,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.03) 2px,
      rgba(0,0,0,0.03) 4px
    );
    pointer-events: none;
    z-index: 999;
  }

  /* Tooltip */
  #tooltip {
    position: fixed;
    background: rgba(5,15,30,0.95);
    border: 1px solid var(--accent);
    border-radius: 3px;
    padding: 6px 12px;
    font-size: 12px;
    letter-spacing: 1px;
    pointer-events: none;
    z-index: 30;
    display: none;
    color: var(--accent);
    font-family: 'Space Mono', monospace;
    box-shadow: 0 0 15px rgba(0,200,255,0.3);
  }

  #loading {
    position: fixed;
    inset: 0;
    background: var(--bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 100;
    gap: 20px;
  }

  .loading-logo {
    font-family: 'Space Mono', monospace;
    font-size: 32px;
    letter-spacing: 10px;
    color: var(--accent);
    text-shadow: 0 0 30px var(--accent);
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .loading-bar-wrap {
    width: 300px;
    height: 2px;
    background: rgba(0,200,255,0.15);
    border-radius: 1px;
    overflow: hidden;
  }

  .loading-bar {
    height: 100%;
    background: var(--accent);
    width: 0;
    animation: load 1.5s ease forwards;
    box-shadow: 0 0 8px var(--accent);
  }

  @keyframes load {
    to { width: 100%; }
  }

  .loading-text {
    font-size: 11px;
    letter-spacing: 3px;
    color: var(--dim);
    text-transform: uppercase;
  }
</style>
</head>
<body>

<div id="loading">
  <div class="loading-logo">ORBIT</div>
  <div class="loading-bar-wrap"><div class="loading-bar"></div></div>
  <div class="loading-text">Инициализация трекера...</div>
</div>

<canvas id="canvas"></canvas>

<div id="hud-top">
  <div class="logo">OR<span>B</span>IT</div>
  <div class="hud-stats">
    <div class="stat-item">
      <div class="stat-val" id="stat-sat">0</div>
      <div class="stat-lbl">СПУТНИКИ</div>
    </div>
    <div class="stat-item">
      <div class="stat-val" id="stat-debris">0</div>
      <div class="stat-lbl">МУСОР</div>
    </div>
    <div class="stat-item">
      <div class="stat-val" id="stat-time">00:00:00</div>
      <div class="stat-lbl">UTC</div>
    </div>
  </div>
</div>

<div id="legend">
  <div class="legend-title">Обозначения</div>
  <div class="legend-item"><div class="dot" style="background:#00ff9f;color:#00ff9f"></div><span>Активный спутник</span></div>
  <div class="legend-item"><div class="dot" style="background:#00c8ff;color:#00c8ff"></div><span>Научный спутник</span></div>
  <div class="legend-item"><div class="dot" style="background:#ffe066;color:#ffe066"></div><span>Метеоспутник</span></div>
  <div class="legend-item"><div class="dot" style="background:#ff4060;color:#ff4060"></div><span>Военный спутник</span></div>
  <div class="legend-item"><div class="dot" style="background:#ff6030;color:#ff6030"></div><span>Космический мусор</span></div>
</div>

<div id="info-panel">
  <div class="panel-header">
    <div class="panel-name" id="panel-name">—</div>
    <div style="display:flex;align-items:center;gap:10px;">
      <div class="panel-type type-active" id="panel-type">ACTIVE</div>
      <button class="close-btn" onclick="closePanel()">✕</button>
    </div>
  </div>
  <div class="tabs">
    <button class="tab active" onclick="switchTab(0)">Основное</button>
    <button class="tab" onclick="switchTab(1)">Подробно</button>
    <button class="tab" onclick="switchTab(2)">Орбита</button>
    <button class="tab" onclick="switchTab(3)">Состояние</button>
  </div>
  <div class="tab-content active" id="tab-0">
    <div class="info-row"><span class="info-key">NORAD ID</span><span class="info-val" id="d-norad">—</span></div>
    <div class="info-row"><span class="info-key">Тип</span><span class="info-val" id="d-type">—</span></div>
    <div class="info-row"><span class="info-key">Страна</span><span class="info-val" id="d-country">—</span></div>
    <div class="info-row"><span class="info-key">Высота орбиты</span><span class="info-val highlight" id="d-alt">—</span></div>
    <div class="info-row"><span class="info-key">Скорость</span><span class="info-val highlight" id="d-speed">—</span></div>
    <div class="info-row"><span class="info-key">Статус</span><span class="info-val" id="d-status">—</span></div>
  </div>
  <div class="tab-content" id="tab-1">
    <div class="info-row"><span class="info-key">Дата запуска</span><span class="info-val" id="d-launch">—</span></div>
    <div class="info-row"><span class="info-key">Оператор</span><span class="info-val" id="d-operator">—</span></div>
    <div class="info-row"><span class="info-key">Масса</span><span class="info-val" id="d-mass">—</span></div>
    <div class="info-row"><span class="info-key">Размах панелей</span><span class="info-val" id="d-span">—</span></div>
    <div class="info-row"><span class="info-key">Назначение</span><span class="info-val" id="d-purpose">—</span></div>
    <div class="info-row"><span class="info-key">Наклонение</span><span class="info-val" id="d-inc">—</span></div>
  </div>
  <div class="tab-content" id="tab-2">
    <div class="orbit-visual">
      <svg class="orbit-svg" id="orbit-svg" viewBox="0 0 120 120">
        <defs>
          <radialGradient id="earthGrad" cx="50%" cy="50%">
            <stop offset="0%" stop-color="#1a6b9e"/>
            <stop offset="100%" stop-color="#0a2d4a"/>
          </radialGradient>
        </defs>
        <circle cx="60" cy="60" r="58" fill="none" stroke="rgba(0,200,255,0.05)" stroke-width="1"/>
        <ellipse id="orbit-ellipse" cx="60" cy="60" rx="45" ry="30" fill="none" stroke="rgba(0,200,255,0.4)" stroke-width="1" stroke-dasharray="3,2"/>
        <circle cx="60" cy="60" r="12" fill="url(#earthGrad)" stroke="rgba(0,200,255,0.3)" stroke-width="0.5"/>
        <circle id="sat-dot" cx="105" cy="60" r="3" fill="#00ff9f"/>
      </svg>
    </div>
    <div class="orbit-stats">
      <div class="info-row"><span class="info-key">Тип орбиты</span><span class="info-val highlight" id="d-orbit-type">—</span></div>
      <div class="info-row"><span class="info-key">Период</span><span class="info-val" id="d-period">—</span></div>
      <div class="info-row"><span class="info-key">Апогей</span><span class="info-val" id="d-apogee">—</span></div>
      <div class="info-row"><span class="info-key">Перигей</span><span class="info-val" id="d-perigee">—</span></div>
      <div class="info-row"><span class="info-key">Эксцентриситет</span><span class="info-val" id="d-ecc">—</span></div>
    </div>
  </div>
  <div class="tab-content" id="tab-3">
    <div class="condition-header">
      <div class="condition-indicator" id="d-cond-dot" style="background:#00ff9f;color:#00ff9f"></div>
      <div class="condition-label" id="d-cond-label">—</div>
    </div>
    <div class="condition-desc" id="d-cond-desc">—</div>
    <div class="condition-metrics">
      <div class="metric-box">
        <span class="metric-val" id="d-cond-power">—</span>
        <span class="metric-lbl">Питание</span>
      </div>
      <div class="metric-box">
        <span class="metric-val" id="d-cond-comms">—</span>
        <span class="metric-lbl">Связь</span>
      </div>
      <div class="metric-box">
        <span class="metric-val" id="d-cond-ctrl">—</span>
        <span class="metric-lbl">Управление</span>
      </div>
      <div class="metric-box">
        <span class="metric-val" id="d-cond-payload">—</span>
        <span class="metric-lbl">Полезная нагрузка</span>
      </div>
    </div>
    <div class="condition-events" id="d-cond-events"></div>
  </div>
</div>

<div id="tooltip"></div>

<div id="controls-hint">
  SCROLL — масштаб<br>
  DRAG — вращение<br>
  CLICK — выбор объекта
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// ─── DATA ───────────────────────────────────────────────────────────────────
const SATELLITES = [
  { id:25544, name:"ISS (Zarya)", type:"Станция", cat:"station", country:"Международная", alt:408, speed:7.66, status:"Активен", launch:"1998-11-20", operator:"NASA/Роскосмос/ESA", mass:"420000 кг", span:"109 м", purpose:"Орбитальная станция", inc:51.6, apogee:422, perigee:402, ecc:0.0006, period:"92.9 мин", orbitType:"НОО", color:0x00ff9f,
    condition:{ label:"Штатная работа", color:"#00ff9f", desc:"МКС функционирует в штатном режиме. На борту находится экипаж из 7 человек. Все системы жизнеобеспечения работают нормально. Регулярные манёвры для поддержания высоты орбиты выполняются двигателями модуля «Звезда» и пристыкованными кораблями.", power:"Норма", comms:"Активна", ctrl:"Норма", payload:"Активна", events:[{date:"2024-03", text:"Пристыковка Crew Dragon — смена экипажа Crew-8"},{date:"2024-01", text:"Проведено плановое ТО системы терморегуляции"},{date:"2023-12", text:"Скафандровая ВКД — обслуживание внешних поверхностей"}] }
  },
  { id:28654, name:"GOES-16", type:"Метеоспутник", cat:"weather", country:"США", alt:35786, speed:3.07, status:"Активен", launch:"2016-11-19", operator:"NOAA", mass:"5192 кг", span:"6.1 м", purpose:"Наблюдение погоды", inc:0.1, apogee:35800, perigee:35774, ecc:0.00004, period:"1436 мин", orbitType:"ГСО", color:0xffe066,
    condition:{ label:"Штатная работа", color:"#00ff9f", desc:"GOES-16 (East) обеспечивает непрерывный мониторинг атмосферы над восточной частью США и Атлантикой. Все 6 инструментов работают без замечаний. Спутник является основным источником метеоданных для NWS.", power:"100%", comms:"Норма", ctrl:"Стабил.", payload:"6/6 акт.", events:[{date:"2024-02", text:"Съёмка крупного циклона Атлантического бассейна — данные переданы в реальном времени"},{date:"2023-10", text:"Обновление прошивки инструмента ABI"},{date:"2022-05", text:"Назначен основным оперативным спутником GOES-East"}] }
  },
  { id:40069, name:"Sentinel-1A", type:"Радарный", cat:"science", country:"ЕС", alt:693, speed:7.46, status:"Активен", launch:"2014-04-03", operator:"ESA", mass:"2300 кг", span:"12.3 м", purpose:"Наблюдение Земли", inc:98.2, apogee:698, perigee:688, ecc:0.0007, period:"99 мин", orbitType:"ССО", color:0x00c8ff,
    condition:{ label:"Частичный отказ", color:"#ffe066", desc:"В августе 2022 года спутник потерял питание из-за аномалии в системе управления электропитанием. ESA прилагает усилия по восстановлению связи, однако по состоянию на 2024 год миссия фактически завершена. Данные SAR-радара недоступны.", power:"Отказ", comms:"Потеряна", ctrl:"Нет", payload:"Нет данных", events:[{date:"2022-08", text:"Зафиксирована аномалия питания, связь потеряна"},{date:"2022-09", text:"ESA объявило об усилиях по восстановлению"},{date:"2023-03", text:"Официально признана потеря спутника, резерв — Sentinel-1B и 1C"}] }
  },
  { id:43013, name:"NOAA-20", type:"Метеоспутник", cat:"weather", country:"США", alt:833, speed:7.41, status:"Активен", launch:"2017-11-18", operator:"NOAA", mass:"2540 кг", span:"7.5 м", purpose:"Метеонаблюдение", inc:98.7, apogee:836, perigee:830, ecc:0.0004, period:"101 мин", orbitType:"ССО", color:0xffe066,
    condition:{ label:"Штатная работа", color:"#00ff9f", desc:"NOAA-20 является основным полярно-орбитальным метеоспутником США. Все пять приборов JPSS функционируют штатно. Обеспечивает глобальное покрытие дважды в сутки. Данные используются для прогнозирования погоды и мониторинга климата.", power:"Норма", comms:"Активна", ctrl:"Норма", payload:"5/5 акт.", events:[{date:"2024-01", text:"Успешный манёвр коррекции орбиты"},{date:"2023-08", text:"Фиксация экстремальных температур в Европе — данные переданы в WMO"},{date:"2022-11", text:"Введён в строй NOAA-21, NOAA-20 сохраняет основную роль"}] }
  },
  { id:44235, name:"Starlink-1007", type:"Интернет", cat:"active", country:"США", alt:550, speed:7.6, status:"Активен", launch:"2019-11-11", operator:"SpaceX", mass:"260 кг", span:"9 м", purpose:"Широкополосный интернет", inc:53.0, apogee:554, perigee:547, ecc:0.0005, period:"95.5 мин", orbitType:"НОО", color:0x00ff9f,
    condition:{ label:"Штатная работа", color:"#00ff9f", desc:"Один из первых аппаратов второй группы созвездия Starlink. Работает в составе орбитальной оболочки Shell 1, обеспечивая интернет-покрытие. Автономная система управления орбитой не требует ручного вмешательства.", power:"Норма", comms:"Активна", ctrl:"Авто", payload:"Онлайн", events:[{date:"2023-06", text:"Выполнен совместный манёвр уклонения от мусора с соседними аппаратами"},{date:"2021-03", text:"Обновление прошивки — улучшение пропускной способности"},{date:"2019-11", text:"Спутник вышел на рабочую орбиту 550 км"}] }
  },
  { id:44237, name:"Starlink-1008", type:"Интернет", cat:"active", country:"США", alt:550, speed:7.6, status:"Активен", launch:"2019-11-11", operator:"SpaceX", mass:"260 кг", span:"9 м", purpose:"Широкополосный интернет", inc:53.0, apogee:554, perigee:547, ecc:0.0005, period:"95.5 мин", orbitType:"НОО", color:0x00ff9f,
    condition:{ label:"Штатная работа", color:"#00ff9f", desc:"Работает в паре с Starlink-1007 в той же орбитальной плоскости. Все системы функционируют нормально, спутник обрабатывает пользовательский трафик в штатном режиме.", power:"Норма", comms:"Активна", ctrl:"Авто", payload:"Онлайн", events:[{date:"2023-11", text:"Профилактическая корректировка орбитальной фазы"},{date:"2022-05", text:"Обновление алгоритма избегания столкновений"},{date:"2019-11", text:"Развёртывание на рабочей орбите"}] }
  },
  { id:37849, name:"Аqua", type:"Научный", cat:"science", country:"США", alt:705, speed:7.45, status:"Активен", launch:"2002-05-04", operator:"NASA", mass:"2934 кг", span:"16.9 м", purpose:"Изучение гидрологии", inc:98.2, apogee:709, perigee:701, ecc:0.0006, period:"98.8 мин", orbitType:"ССО", color:0x00c8ff,
    condition:{ label:"Деградация систем", color:"#ffe066", desc:"Спутник Aqua работает более 22 лет, значительно превысив расчётный ресурс. Прибор AMSR-E отключён в 2011 году из-за проблем с редуктором. Остальные инструменты продолжают работу с ограничениями. NASA планирует постепенное выведение из эксплуатации.", power:"~85%", comms:"Норма", ctrl:"Норма", payload:"5/6 акт.", events:[{date:"2024-02", text:"Продолжается мониторинг глобальных водных ресурсов — данные MODIS"},{date:"2023-07", text:"Обнаружена аномалия в системе записи данных — применены обходные методы"},{date:"2011-10", text:"Отключён AMSR-E из-за неисправности редуктора вращения"}] }
  },
  { id:36036, name:"COSMO-SkyMed", type:"Радарный", cat:"military", country:"Италия", alt:619, speed:7.5, status:"Активен", launch:"2008-06-07", operator:"ASI/Минобороны", mass:"1700 кг", span:"9 м", purpose:"Военная разведка", inc:97.8, apogee:623, perigee:615, ecc:0.0006, period:"97.1 мин", orbitType:"ССО", color:0xff4060,
    condition:{ label:"Штатная работа", color:"#00ff9f", desc:"Спутник SAR-радарного наблюдения функционирует в составе итальянской разведывательной группировки. Информация о состоянии систем ограничена — военная миссия. Расчётный ресурс составлял 5 лет, однако спутник продолжает работу.", power:"Засекр.", comms:"Шифр.", ctrl:"Засекр.", payload:"Активна", events:[{date:"2024-01", text:"[ЗАСЕКРЕЧЕНО] Плановая операция наблюдения"},{date:"2022-03", text:"[ЗАСЕКРЕЧЕНО] Участие в международной разведывательной миссии"},{date:"2008-06", text:"Запуск с Vandenberg — успешный выход на целевую орбиту"}] }
  },
  { id:25258, name:"XMM-Newton", type:"Научный", cat:"science", country:"ЕС", alt:113894, speed:1.82, status:"Активен", launch:"1999-12-10", operator:"ESA", mass:"3800 кг", span:"16 м", purpose:"Рентгеновская астрономия", inc:70.0, apogee:114000, perigee:7000, ecc:0.8, period:"2872 мин", orbitType:"ВЭО", color:0x00c8ff,
    condition:{ label:"Плановая работа", color:"#00ff9f", desc:"XMM-Newton — старейший действующий рентгеновский телескоп ЕКА. Работает более 25 лет. Основные научные приборы EPIC и RGS функционируют. Гироскопы показывают деградацию, однако управление ориентацией сохраняется. Миссия продлена до 2026 года.", power:"Норма", comms:"12 ч/виток", ctrl:"Стабил.", payload:"3/3 акт.", events:[{date:"2024-03", text:"Открытие сверхмассивной чёрной дыры в 10 млрд св. лет — статья в Nature"},{date:"2023-09", text:"Наблюдение вспышки нейтронной звезды в Млечном Пути"},{date:"2022-12", text:"Продление миссии до конца 2026 года по решению научного совета ESA"}] }
  },
  { id:43227, name:"GSAT-19", type:"Связь", cat:"active", country:"Индия", alt:35786, speed:3.07, status:"Активен", launch:"2017-06-05", operator:"ISRO", mass:"3136 кг", span:"12 м", purpose:"Телекоммуникации", inc:0.05, apogee:35790, perigee:35782, ecc:0.00006, period:"1436 мин", orbitType:"ГСО", color:0x00ff9f,
    condition:{ label:"Штатная работа", color:"#00ff9f", desc:"GSAT-19 — экспериментальный коммуникационный спутник ISRO. Первый индийский спутник с Q/V-диапазоном. Все бортовые системы работают штатно. Служит платформой для отработки новых технологий связи для будущих миссий.", power:"Норма", comms:"Норма", ctrl:"Норма", payload:"Активна", events:[{date:"2024-01", text:"Успешное тестирование нового протокола Ka-диапазона"},{date:"2023-06", text:"Прошло 6 лет с запуска — все системы в норме"},{date:"2017-06", text:"Запуск на GSLV Mk III — первый полёт новой ракеты"}] }
  },
  { id:33591, name:"ГЛОНАСС-М №52", type:"Навигация", cat:"active", country:"Россия", alt:19140, speed:3.87, status:"Активен", launch:"2008-09-25", operator:"Роскосмос", mass:"1480 кг", span:"7.2 м", purpose:"Навигация ГЛОНАСС", inc:64.8, apogee:19150, perigee:19130, ecc:0.001, period:"675 мин", orbitType:"СОО", color:0x00ff9f,
    condition:{ label:"Деградация систем", color:"#ffe066", desc:"Спутник ГЛОНАСС-М эксплуатируется свыше 15 лет при расчётном ресурсе 7 лет. Атомные часы работают с повышенными погрешностями. Точность навигационного сигнала снижена. По данным ИКД, спутник помечен как нездоровый в отдельных периодах.", power:"~78%", comms:"Работает", ctrl:"Норма", payload:"Деградация", events:[{date:"2023-11", text:"Временное отключение — техническая аномалия атомных часов"},{date:"2022-05", text:"Плановая коррекция орбиты"},{date:"2020-03", text:"Превышен расчётный ресурс — принято решение о продлении миссии"}] }
  },
  { id:32393, name:"GPS IIR-20", type:"Навигация", cat:"active", country:"США", alt:20200, speed:3.87, status:"Активен", launch:"2007-10-17", operator:"USAF", mass:"2032 кг", span:"9 м", purpose:"Навигация GPS", inc:55.0, apogee:20220, perigee:20185, ecc:0.009, period:"717 мин", orbitType:"СОО", color:0x00ff9f,
    condition:{ label:"Штатная работа", color:"#00ff9f", desc:"GPS IIR-20 (PRN 05) — один из старейших действующих спутников блока IIR. Все три атомных цезиевых часа работают в норме. Точность сигнала в пределах спецификации. Планируется замена на спутник блока III в ближайшие годы.", power:"Норма", comms:"Норма", ctrl:"Норма", payload:"Норма", events:[{date:"2024-01", text:"Плановая загрузка навигационного сообщения с контрольного сегмента"},{date:"2023-07", text:"Тест нового алгоритма антиспуфинга L1C"},{date:"2007-10", text:"Запуск на Delta II — выход на орбиту плоскости C"}] }
  },
  { id:27607, name:"Envisat", type:"Научный", cat:"science", country:"ЕС", alt:782, speed:7.45, status:"Неактивен", launch:"2002-03-01", operator:"ESA", mass:"8211 кг", span:"26 м", purpose:"Мониторинг окружающей среды", inc:98.5, apogee:786, perigee:778, ecc:0.0005, period:"100.6 мин", orbitType:"ССО", color:0x00c8ff,
    condition:{ label:"Потерян / Мусор", color:"#ff4060", desc:"8 апреля 2012 года ESA потеряло связь с Envisat. Причина до сих пор точно не установлена: предположительно, произошло короткое замыкание в системе электропитания. Спутник весом 8 тонн является одним из крупнейших объектов космического мусора на ССО.", power:"Нет", comms:"Потеряна", ctrl:"Нет", payload:"Нет данных", events:[{date:"2012-04", text:"Потеря связи. Многократные попытки восстановления не дали результата"},{date:"2012-05", text:"ESA официально объявило об окончании миссии"},{date:"2012-09", text:"Оценка как нефункционального объекта — угроза столкновений на ССО"}] }
  },
];

const DEBRIS_SOURCES = [
  "Ступень ракеты «Союз»","Обломок спутника Fengyun-1C","Фрагмент Cosmos 2251","Обломок Iridium 33",
  "Верхняя ступень Delta II","Фрагмент взрыва Ariane","Обломок SPOT-4","Фрагмент OrbView-2",
  "Обломок китайского ASAT","Фрагмент Pegasus","Обломок DMSP","Фрагмент NOAA-7",
];
const COLLISION_TARGETS = [
  "ISS","Starlink-группировка","Sentinel-1C","NOAA-20","GPS III","Aqua","Landsat-9",
  "TerraSAR-X","GOES-18","Hubble ST","Envisat","MetOp-B",
];

const DEBRIS = Array.from({length:120}, (_, i) => {
  const altVal = 300 + Math.random() * 1500;
  const riskBase = altVal < 600 ? 0.4 : altVal < 900 ? 0.25 : altVal < 1200 ? 0.15 : 0.05;
  const riskRand = Math.random();
  const risk = Math.min(0.99, riskBase * (0.5 + riskRand));
  const riskLevel = risk > 0.3 ? "КРИТИЧЕСКАЯ" : risk > 0.15 ? "ВЫСОКАЯ" : risk > 0.07 ? "СРЕДНЯЯ" : "НИЗКАЯ";
  const riskColor = risk > 0.3 ? "#ff2040" : risk > 0.15 ? "#ff6030" : risk > 0.07 ? "#ffe066" : "#00ff9f";
  const closestApproach = (1.2 + Math.random() * 50).toFixed(1);
  const daysToCA = Math.floor(1 + Math.random() * 90);
  const source = DEBRIS_SOURCES[i % DEBRIS_SOURCES.length];
  const target = COLLISION_TARGETS[Math.floor(Math.random() * COLLISION_TARGETS.length)];
  const relSpeed = (7 + Math.random() * 8).toFixed(2);
  const massVal = (Math.random()*100).toFixed(1);

  return {
    id: 90000 + i,
    name: `Обломок #${(i+1).toString().padStart(4,'0')}`,
    type: "Космический мусор",
    cat: "debris",
    country: "—",
    alt: altVal,
    speed: 7.0 + Math.random() * 1.5,
    status: "Мусор",
    launch: "—",
    operator: "—",
    mass: `${massVal} кг`,
    span: `${(Math.random()*2).toFixed(2)} м`,
    purpose: "Фрагмент ракеты / спутника",
    inc: 20 + Math.random() * 140,
    apogee: altVal + Math.random() * 100,
    perigee: altVal - Math.random() * 80,
    ecc: (Math.random() * 0.05).toFixed(4),
    period: `${(88 + Math.random()*30).toFixed(1)} мин`,
    orbitType: "НОО",
    color: 0xff6030,
    collision: { risk, riskLevel, riskColor, closestApproach, daysToCA, source, target, relSpeed },
    condition:{
      label: `Опасность: ${riskLevel}`,
      color: riskColor,
      desc: `Неактивный фрагмент космического мусора. Происхождение: ${source}. Объект отслеживается наземными радарами сети SSN/LeoLabs. Масса: ${massVal} кг. Относительная скорость сближения: ${relSpeed} км/с.`,
      power:"Нет", comms:"Нет", ctrl:"Нет", payload:"Нет",
      events:[
        {date:"Угроза", text:`Ближайший объект под угрозой: ${target}`},
        {date:"Сближение", text:`Минимальное расстояние: ${closestApproach} км через ${daysToCA} дн.`},
        {date:"Скорость", text:`Относительная скорость: ${relSpeed} км/с (летально при >0.1 км/с)`},
      ]
    }
  };
});

const ALL_OBJECTS = [...SATELLITES, ...DEBRIS];

// ─── THREE.JS SETUP ──────────────────────────────────────────────────────────
const canvas = document.getElementById('canvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 0.8;

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100000);
camera.position.set(0, 0, 25);

// Lights
const ambient = new THREE.AmbientLight(0x0a0a1a, 0.8);
scene.add(ambient);

// Sun position (orbits slowly)
const SUN_DISTANCE = 400;
const sunAngleRef = { val: 0 };

const sunLight = new THREE.PointLight(0xfff5e0, 3.0, 2000, 0.2);
sunLight.position.set(SUN_DISTANCE, 40, 0);
scene.add(sunLight);

// Secondary fill from sun (soft)
const sunFill = new THREE.DirectionalLight(0xffe8c0, 0.4);
scene.add(sunFill);

// Deep space backlight (very faint blue rim)
const backLight = new THREE.DirectionalLight(0x0a1a33, 0.25);
backLight.position.set(-1, -0.5, -1);
scene.add(backLight);

// ─── SUN MESH ────────────────────────────────────────────────────────────────
const sunGeo = new THREE.SphereGeometry(5, 32, 32);
const sunMat = new THREE.MeshBasicMaterial({ color: 0xfff5c0 });
const sunMesh = new THREE.Mesh(sunGeo, sunMat);
sunMesh.position.set(SUN_DISTANCE, 40, 0);
scene.add(sunMesh);

// Sun corona glow layers
const coronaColors = [0xfffaaa, 0xffcc44, 0xff8800];
const coronaSizes  = [6.8, 9.5, 14];
const coronaOpacities = [0.35, 0.15, 0.06];
const coronaMeshes = coronaColors.map((col, ci) => {
  const cGeo = new THREE.SphereGeometry(coronaSizes[ci], 16, 16);
  const cMat = new THREE.MeshBasicMaterial({
    color: col,
    transparent: true,
    opacity: coronaOpacities[ci],
    depthWrite: false,
    side: THREE.FrontSide,
  });
  const cm = new THREE.Mesh(cGeo, cMat);
  scene.add(cm);
  return cm;
});

// Sun lens flare — simple sprite-like billboard quad
const flareGeo = new THREE.PlaneGeometry(30, 30);
const flareMat = new THREE.MeshBasicMaterial({
  color: 0xffe066,
  transparent: true,
  opacity: 0.07,
  depthWrite: false,
  side: THREE.DoubleSide,
});
const flareMesh = new THREE.Mesh(flareGeo, flareMat);
scene.add(flareMesh);

// Stars
const starsGeo = new THREE.BufferGeometry();
const starPositions = new Float32Array(15000 * 3);
for (let i = 0; i < 15000 * 3; i++) {
  starPositions[i] = (Math.random() - 0.5) * 2000;
}
starsGeo.setAttribute('position', new THREE.BufferAttribute(starPositions, 3));
const starMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.3, sizeAttenuation: true });
scene.add(new THREE.Points(starsGeo, starMat));

// Earth
const earthGeo = new THREE.SphereGeometry(6.371, 64, 64);
const earthMat = new THREE.MeshPhongMaterial({
  color: 0x1a4080,
  emissive: 0x020810,
  specular: 0x226699,
  shininess: 60,
});

// Canvas texture for earth
const texCanvas = document.createElement('canvas');
texCanvas.width = 1024; texCanvas.height = 512;
const ctx2d = texCanvas.getContext('2d');

// Ocean
const oceanGrad = ctx2d.createLinearGradient(0, 0, 0, 512);
oceanGrad.addColorStop(0, '#061830');
oceanGrad.addColorStop(0.5, '#0a3060');
oceanGrad.addColorStop(1, '#051525');
ctx2d.fillStyle = oceanGrad;
ctx2d.fillRect(0, 0, 1024, 512);

// Grid lines
ctx2d.strokeStyle = 'rgba(0,150,255,0.08)';
ctx2d.lineWidth = 0.5;
for (let x = 0; x < 1024; x += 64) {
  ctx2d.beginPath(); ctx2d.moveTo(x, 0); ctx2d.lineTo(x, 512); ctx2d.stroke();
}
for (let y = 0; y < 512; y += 32) {
  ctx2d.beginPath(); ctx2d.moveTo(0, y); ctx2d.lineTo(1024, y); ctx2d.stroke();
}

// Simple continents
function drawContinent(pts, col) {
  ctx2d.fillStyle = col;
  ctx2d.beginPath();
  ctx2d.moveTo(pts[0][0], pts[0][1]);
  for (let i = 1; i < pts.length; i++) ctx2d.lineTo(pts[i][0], pts[i][1]);
  ctx2d.closePath();
  ctx2d.fill();
}

const continents = [
  // Africa
  [[450,200],[510,200],[540,240],[530,280],[500,330],[470,330],[445,290],[440,250]],
  // Europe
  [[435,140],[510,135],[520,160],[490,180],[455,180],[435,165]],
  // Asia
  [[510,130],[700,120],[750,160],[720,200],[660,220],[570,210],[510,180]],
  // Americas
  [[150,140],[220,130],[240,180],[220,270],[200,330],[175,350],[155,300],[145,220]],
  // Australia
  [[660,290],[720,285],[740,320],[710,350],[665,345],[645,315]],
  // Antarctica
  [[0,460],[1024,460],[1024,512],[0,512]],
];
const landColors = ['#1a5c2a','#1a6b30','#1d7835','#175526','#1a6030','#2a4a35'];
continents.forEach((pts, i) => drawContinent(pts, landColors[i % landColors.length]));

// Ice caps
ctx2d.fillStyle = 'rgba(200,230,255,0.4)';
ctx2d.fillRect(0, 0, 1024, 30);
ctx2d.fillRect(0, 460, 1024, 52);

const earthTex = new THREE.CanvasTexture(texCanvas);
earthMat.map = earthTex;
const earth = new THREE.Mesh(earthGeo, earthMat);
scene.add(earth);

// Atmosphere
const atmGeo = new THREE.SphereGeometry(6.85, 32, 32);
const atmMat = new THREE.MeshPhongMaterial({
  color: 0x1166cc,
  transparent: true,
  opacity: 0.12,
  side: THREE.FrontSide,
  depthWrite: false,
});
scene.add(new THREE.Mesh(atmGeo, atmMat));

// Atmosphere rim
const rimGeo = new THREE.SphereGeometry(7.2, 32, 32);
const rimMat = new THREE.MeshPhongMaterial({
  color: 0x0088ff,
  transparent: true,
  opacity: 0.04,
  side: THREE.BackSide,
  depthWrite: false,
});
scene.add(new THREE.Mesh(rimGeo, rimMat));

// ─── SATELLITE OBJECTS ───────────────────────────────────────────────────────
const EARTH_RADIUS = 6.371;
const KM_TO_UNIT = EARTH_RADIUS / 6371;

const satMeshes = [];
const orbitLines = [];
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

// Orbit angles per object
const orbitData = ALL_OBJECTS.map((sat, i) => ({
  inc: sat.inc * Math.PI / 180,
  speed: 0.00005 + Math.random() * 0.0001 * (sat.cat === 'debris' ? 2 : 1),
  angle: Math.random() * Math.PI * 2,
  node: Math.random() * Math.PI * 2,
  radius: EARTH_RADIUS + sat.alt * KM_TO_UNIT,
}));

ALL_OBJECTS.forEach((sat, i) => {
  const od = orbitData[i];
  const isDebris = sat.cat === 'debris';
  const size = isDebris ? 0.025 : (sat.cat === 'station' ? 0.12 : 0.05);

  let geo, mat;
  if (isDebris) {
    geo = new THREE.OctahedronGeometry(size);
    mat = new THREE.MeshPhongMaterial({ color: sat.color, emissive: sat.color, emissiveIntensity: 0.3 });
  } else {
    geo = new THREE.BoxGeometry(size, size * 0.3, size * 1.8);
    mat = new THREE.MeshPhongMaterial({ color: sat.color, emissive: sat.color, emissiveIntensity: 0.5, shininess: 80 });
  }

  const mesh = new THREE.Mesh(geo, mat);
  mesh.userData = { satIndex: i };
  scene.add(mesh);
  satMeshes.push(mesh);

  // Invisible hitbox for easier clicking
  const hitSize = isDebris ? 0.12 : 0.18;
  const hitGeo = new THREE.SphereGeometry(hitSize, 6, 6);
  const hitMat = new THREE.MeshBasicMaterial({ visible: false });
  const hitbox = new THREE.Mesh(hitGeo, hitMat);
  hitbox.userData = { satIndex: i };
  mesh.add(hitbox);

  // Glow as separate scene object (not child of mesh)
  const glowGeo = new THREE.SphereGeometry(isDebris ? 0.06 : 0.12, 8, 8);
  const glowMat = new THREE.MeshBasicMaterial({ color: sat.color, transparent: true, opacity: 0.25, depthWrite: false });
  const glow = new THREE.Mesh(glowGeo, glowMat);
  glow.userData = { satIndex: i };
  scene.add(glow);
  // store reference so we can update position in animation loop
  mesh.userData.glowMesh = glow;

  // Orbit line
  if (!isDebris) {
    const pts = [];
    const steps = 128;
    for (let s = 0; s <= steps; s++) {
      const a = (s / steps) * Math.PI * 2;
      const x = Math.cos(a) * od.radius;
      const y = Math.sin(a) * od.radius * Math.cos(od.inc);
      const z = Math.sin(a) * od.radius * Math.sin(od.inc);
      const v = new THREE.Vector3(x, y, z);
      v.applyAxisAngle(new THREE.Vector3(0, 1, 0), od.node);
      pts.push(v);
    }
    const lineGeo = new THREE.BufferGeometry().setFromPoints(pts);
    const lineMat = new THREE.LineBasicMaterial({ color: sat.color, transparent: true, opacity: 0.15 });
    const line = new THREE.Line(lineGeo, lineMat);
    scene.add(line);
    orbitLines.push({ line, satIndex: i });
  }
});

document.getElementById('stat-sat').textContent = SATELLITES.length;
document.getElementById('stat-debris').textContent = DEBRIS.length;

// ─── CONTROLS ────────────────────────────────────────────────────────────────
let isDragging = false, prevMouse = { x: 0, y: 0 };
let dragMoved = false;
let theta = 0, phi = Math.PI / 2;
let zoom = 25;
const ZOOM_MIN = 10, ZOOM_MAX = 2000;

canvas.addEventListener('mousedown', e => {
  if (e.target !== canvas) return;
  isDragging = true;
  dragMoved = false;
  prevMouse = { x: e.clientX, y: e.clientY };
});

canvas.addEventListener('mousemove', e => {
  if (isDragging) {
    const dx = e.clientX - prevMouse.x;
    const dy = e.clientY - prevMouse.y;
    if (Math.abs(dx) > 2 || Math.abs(dy) > 2) dragMoved = true;
    theta += dx * 0.005;
    phi = Math.max(0.1, Math.min(Math.PI - 0.1, phi - dy * 0.005));
    prevMouse = { x: e.clientX, y: e.clientY };
  }

  // Tooltip
  mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  const hits = raycaster.intersectObjects(satMeshes, true);
  const tooltip = document.getElementById('tooltip');
  if (hits.length > 0) {
    let obj = hits[0].object;
    while (obj && obj.userData.satIndex === undefined && obj.parent) obj = obj.parent;
    const idx = obj?.userData?.satIndex;
    const sat = idx !== undefined ? ALL_OBJECTS[idx] : null;
    if (sat) {
      tooltip.textContent = sat.name;
      tooltip.style.display = 'block';
      tooltip.style.left = (e.clientX + 14) + 'px';
      tooltip.style.top = (e.clientY - 10) + 'px';
      document.body.style.cursor = 'pointer';
    } else {
      tooltip.style.display = 'none';
      document.body.style.cursor = 'crosshair';
    }
  } else {
    tooltip.style.display = 'none';
    document.body.style.cursor = 'crosshair';
  }
});

window.addEventListener('mouseup', () => { isDragging = false; });

canvas.addEventListener('wheel', e => {
  zoom *= (1 + e.deltaY * 0.001);
  zoom = Math.max(ZOOM_MIN, Math.min(ZOOM_MAX, zoom));
});

canvas.addEventListener('click', e => {
  if (dragMoved) { dragMoved = false; return; }
  mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);

  const hits = raycaster.intersectObjects(satMeshes, true);
  if (hits.length > 0) {
    let obj = hits[0].object;
    while (obj && obj.userData.satIndex === undefined && obj.parent) obj = obj.parent;
    const idx = obj?.userData?.satIndex;
    if (idx !== undefined) showPanel(ALL_OBJECTS[idx]);
  }
});

// ─── PANEL ───────────────────────────────────────────────────────────────────
let currentTab = 0;

function showPanel(sat) {
  const isDebris = sat.cat === 'debris';
  document.getElementById('panel-name').textContent = sat.name;
  const typeEl = document.getElementById('panel-type');
  typeEl.textContent = isDebris ? 'МУСОР' : 'ACTIVE';
  typeEl.className = 'panel-type ' + (isDebris ? 'type-debris' : 'type-active');

  document.getElementById('d-norad').textContent = sat.id;
  document.getElementById('d-type').textContent = sat.type;
  document.getElementById('d-country').textContent = sat.country;
  document.getElementById('d-alt').textContent = sat.alt >= 1000 ? `${(sat.alt/1000).toFixed(1)} тыс. км` : `${sat.alt} км`;
  document.getElementById('d-speed').textContent = `${sat.speed} км/с`;
  document.getElementById('d-status').textContent = sat.status;

  document.getElementById('d-launch').textContent = sat.launch;
  document.getElementById('d-operator').textContent = sat.operator;
  document.getElementById('d-mass').textContent = sat.mass;
  document.getElementById('d-span').textContent = sat.span;
  document.getElementById('d-purpose').textContent = sat.purpose;
  document.getElementById('d-inc').textContent = `${sat.inc}°`;

  document.getElementById('d-orbit-type').textContent = sat.orbitType;
  document.getElementById('d-period').textContent = sat.period;
  document.getElementById('d-apogee').textContent = `${sat.apogee} км`;
  document.getElementById('d-perigee').textContent = `${sat.perigee} км`;
  document.getElementById('d-ecc').textContent = sat.ecc;

  // Orbit SVG
  const maxAlt = Math.max(sat.apogee, 36000);
  const scale = 45 / (EARTH_RADIUS * 1000 + maxAlt) * (EARTH_RADIUS * 1000);
  const rx = 45;
  const ry = Math.max(10, rx * (1 - parseFloat(sat.ecc)));
  document.getElementById('orbit-ellipse').setAttribute('rx', rx);
  document.getElementById('orbit-ellipse').setAttribute('ry', ry);
  const satColor = '#' + sat.color.toString(16).padStart(6, '0');
  document.getElementById('sat-dot').setAttribute('fill', satColor);

  // Condition tab
  const cond = sat.condition;
  const dot = document.getElementById('d-cond-dot');
  dot.style.background = cond.color;
  dot.style.color = cond.color;
  document.getElementById('d-cond-label').textContent = cond.label;
  document.getElementById('d-cond-label').style.color = cond.color;
  document.getElementById('d-cond-desc').textContent = cond.desc;

  const setMetric = (id, val) => {
    const el = document.getElementById(id);
    el.textContent = val;
    el.className = 'metric-val';
    if (val === 'Нет' || val === 'Отказ' || val === 'Потеряна') el.classList.add('warn');
    else if (val === 'Деградация' || val.includes('%') && parseInt(val) < 90) el.classList.add('neutral');
  };
  setMetric('d-cond-power', cond.power);
  setMetric('d-cond-comms', cond.comms);
  setMetric('d-cond-ctrl', cond.ctrl);
  setMetric('d-cond-payload', cond.payload);

  const eventsEl = document.getElementById('d-cond-events');
  eventsEl.innerHTML = '';

  // Collision risk block for debris
  if (sat.cat === 'debris' && sat.collision) {
    const col = sat.collision;
    const pct = (col.risk * 100).toFixed(2);
    const barColor = col.risk > 0.3 ? '#ff2040' : col.risk > 0.15 ? '#ff6030' : col.risk > 0.07 ? '#ffe066' : '#00ff9f';
    const block = document.createElement('div');
    block.className = 'collision-block';
    block.innerHTML = `
      <div class="collision-header">Опасность столкновения</div>
      <div class="risk-bar-wrap">
        <div class="risk-label-row">
          <span class="risk-label">ВЕРОЯТНОСТЬ</span>
          <span class="risk-value" style="color:${barColor}">${pct}% — ${col.riskLevel}</span>
        </div>
        <div class="risk-bar-bg"><div class="risk-bar-fill" style="width:${Math.min(100, col.risk*100*3)}%;background:${barColor}"></div></div>
      </div>
      <div class="collision-details">
        <div class="cd-item"><span class="cd-key">ЦЕЛЬ</span><span class="cd-val" style="color:${barColor}">${col.target}</span></div>
        <div class="cd-item"><span class="cd-key">МИН. РАССТ.</span><span class="cd-val">${col.closestApproach} км</span></div>
        <div class="cd-item"><span class="cd-key">ЧЕРЕЗ</span><span class="cd-val">${col.daysToCA} дн.</span></div>
        <div class="cd-item"><span class="cd-key">ОТН. СКОРОСТЬ</span><span class="cd-val">${col.relSpeed} км/с</span></div>
      </div>
    `;
    eventsEl.appendChild(block);
  }

  if (cond.events && cond.events.length) {
    const title = document.createElement('div');
    title.style.cssText = 'font-size:10px;letter-spacing:2px;color:var(--dim);margin-bottom:6px;margin-top:10px;text-transform:uppercase;';
    title.textContent = sat.cat === 'debris' ? 'Данные отслеживания' : 'Хроника событий';
    eventsEl.appendChild(title);
    cond.events.forEach(ev => {
      const div = document.createElement('div');
      div.className = 'event-item';
      div.innerHTML = `<span class="event-date">${ev.date}</span><span class="event-text">${ev.text}</span>`;
      eventsEl.appendChild(div);
    });
  }

  switchTab(0);
  const panel = document.getElementById('info-panel');
  panel.removeAttribute('style');
  panel.className = 'visible';
}

function closePanel() {
  const panel = document.getElementById('info-panel');
  panel.className = '';
}

function switchTab(n) {
  currentTab = n;
  document.querySelectorAll('.tab').forEach((t, i) => t.className = 'tab' + (i === n ? ' active' : ''));
  document.querySelectorAll('.tab-content').forEach((c, i) => c.className = 'tab-content' + (i === n ? ' active' : ''));
}

// ─── ANIMATION ───────────────────────────────────────────────────────────────
let t = 0;

function animate() {
  requestAnimationFrame(animate);
  t += 0.016;

  // Time
  const now = new Date();
  document.getElementById('stat-time').textContent =
    now.getUTCHours().toString().padStart(2,'0') + ':' +
    now.getUTCMinutes().toString().padStart(2,'0') + ':' +
    now.getUTCSeconds().toString().padStart(2,'0');

  // Camera
  camera.position.x = zoom * Math.sin(phi) * Math.cos(theta);
  camera.position.y = zoom * Math.cos(phi);
  camera.position.z = zoom * Math.sin(phi) * Math.sin(theta);
  camera.lookAt(0, 0, 0);

  // Earth rotation
  earth.rotation.y += 0.0008;

  // Sun slow orbit
  sunAngleRef.val += 0.0003;
  const sx = Math.cos(sunAngleRef.val) * SUN_DISTANCE;
  const sy = Math.sin(sunAngleRef.val * 0.3) * 40;
  const sz = Math.sin(sunAngleRef.val) * SUN_DISTANCE;

  sunMesh.position.set(sx, sy, sz);
  sunLight.position.set(sx, sy, sz);
  sunFill.position.set(sx, sy, sz);
  sunFill.target.position.set(0, 0, 0);
  scene.add(sunFill.target);

  // Corona pulse
  const pulse = 1 + Math.sin(t * 2.5) * 0.03;
  coronaMeshes.forEach(cm => {
    cm.position.set(sx, sy, sz);
    cm.scale.setScalar(pulse);
  });

  // Flare billboard — always face camera
  flareMesh.position.set(sx, sy, sz);
  flareMesh.lookAt(camera.position);
  // fade flare based on angle between sun and camera direction
  const camToSun = new THREE.Vector3(sx, sy, sz).normalize();
  const camDir = new THREE.Vector3().subVectors(new THREE.Vector3(sx,sy,sz), camera.position).normalize();
  const flareIntensity = Math.max(0, camDir.dot(camToSun.negate()) * 0.1);
  flareMesh.material.opacity = flareIntensity;

  // Update satellites
  ALL_OBJECTS.forEach((sat, i) => {
    const od = orbitData[i];
    od.angle += od.speed;

    const x = Math.cos(od.angle) * od.radius;
    const y = Math.sin(od.angle) * od.radius * Math.cos(od.inc);
    const z = Math.sin(od.angle) * od.radius * Math.sin(od.inc);

    const pos = new THREE.Vector3(x, y, z);
    pos.applyAxisAngle(new THREE.Vector3(0, 1, 0), od.node);

    satMeshes[i].position.copy(pos);
    satMeshes[i].lookAt(0, 0, 0);
    satMeshes[i].rotateX(Math.PI / 2);

    // Sync glow mesh position
    if (satMeshes[i].userData.glowMesh) {
      satMeshes[i].userData.glowMesh.position.copy(pos);
    }

    // Scale with zoom
    const scaleFactor = zoom / 25;
    satMeshes[i].scale.setScalar(Math.max(0.5, Math.min(3, scaleFactor)));
  });

  renderer.render(scene, camera);
}

// ─── INIT ────────────────────────────────────────────────────────────────────
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

// Touch support
canvas.addEventListener('touchstart', e => {
  isDragging = true;
  prevMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
});
canvas.addEventListener('touchmove', e => {
  if (!isDragging) return;
  const dx = e.touches[0].clientX - prevMouse.x;
  const dy = e.touches[0].clientY - prevMouse.y;
  theta += dx * 0.005;
  phi = Math.max(0.1, Math.min(Math.PI - 0.1, phi - dy * 0.005));
  prevMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
  e.preventDefault();
}, { passive: false });
canvas.addEventListener('touchend', () => isDragging = false);

setTimeout(() => {
  document.getElementById('loading').style.opacity = '0';
  document.getElementById('loading').style.transition = 'opacity 0.5s';
  setTimeout(() => document.getElementById('loading').style.display = 'none', 500);
  animate();
}, 1600);
</script>
</body>
</html>
